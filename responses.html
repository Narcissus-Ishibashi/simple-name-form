<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ—¥æ™‚åˆ¥é›†è¨ˆ</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Noto Sans JP', sans-serif;
      background-color: #f8f8f8;
      padding: 40px 24px;
    }
    h1 {
      text-align: center;
      font-size: 26px;
      margin-bottom: 30px;
    }
    .summary {
      max-width: 600px;
      margin: 0 auto;
    }
    .day-row {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 14px 20px;
      margin-bottom: 14px;
      font-size: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    .label {
      font-weight: bold;
      margin-bottom: 4px;
    }
    .counts {
      display: flex;
      gap: 16px;
    }
    .crown {
      font-size: 18px;
      margin-left: 8px;
      color: #d4af37;
    }
    .clear-area {
      text-align: center;
      margin-top: 40px;
    }
    .clear-button {
      padding: 10px 20px;
      font-size: 16px;
      background-color: #e53935;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .back-link {
      text-align: center;
      margin-top: 30px;
    }
    .back-link a {
      color: #2e7d7c;
      font-weight: bold;
      text-decoration: none;
    }
    .back-link a:hover {
      text-decoration: underline;
    }
    @media (max-width: 480px) {
      .day-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
    }
  </style>
</head>
<body>
  <h1>ğŸ“Š æ—¥æ™‚åˆ¥å‚åŠ äººæ•° é›†è¨ˆ</h1>
  <div class="summary" id="summary"></div>

  <div class="clear-area">
    <button id="clear-button" class="clear-button">å›ç­”ã‚’å…¨ã¦ã‚¯ãƒªã‚¢ã«ã™ã‚‹</button>
  </div>

  <div class="back-link">
    <a href="index.html">â† ãƒ•ã‚©ãƒ¼ãƒ ã«æˆ»ã‚‹</a>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyATmNqFm7juv8Vie3-62-L62BG8pCnCxWQ",
      authDomain: "github-nomikai-form.firebaseapp.com",
      projectId: "github-nomikai-form",
      storageBucket: "github-nomikai-form.firebasestorage.app",
      messagingSenderId: "1025705286107",
      appId: "1:1025705286107:web:8d915cd8273e5d58c96ffe",
      measurementId: "G-SKHX86H3E5"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const summary = document.getElementById("summary");

    const days = [
      "6æœˆ1æ—¥ï¼ˆæ—¥ï¼‰",
      "6æœˆ7æ—¥ï¼ˆåœŸï¼‰",
      "6æœˆ8æ—¥ï¼ˆæ—¥ï¼‰",
      "6æœˆ14æ—¥ï¼ˆåœŸï¼‰",
      "6æœˆ15æ—¥ï¼ˆæ—¥ï¼‰",
      "6æœˆ21æ—¥ï¼ˆåœŸï¼‰",
      "6æœˆ22æ—¥ï¼ˆæ—¥ï¼‰",
      "6æœˆ28æ—¥ï¼ˆåœŸï¼‰",
      "6æœˆ29æ—¥ï¼ˆæ—¥ï¼‰"
    ];

    const counts = {};
    days.forEach(day => {
      counts[day] = { æ˜¼: 0, å¤œ: 0 };
    });

    db.collection("responses").get().then(snapshot => {
      snapshot.forEach(doc => {
        const data = doc.data();
        const responses = data.responses || {};
        days.forEach(day => {
          const answer = responses[day];
          if (answer?.æ˜¼) counts[day].æ˜¼ += 1;
          if (answer?.å¤œ) counts[day].å¤œ += 1;
        });
      });

      // ğŸ‘‘ ä¸€ç•ªå¤šã„æ ã‚’æ¢ã™
      let maxCount = 0;
      let maxSlots = []; // [{ day: "6æœˆXæ—¥", time: "æ˜¼" }]
      days.forEach(day => {
        ["æ˜¼", "å¤œ"].forEach(time => {
          const value = counts[day][time];
          if (value > maxCount) {
            maxCount = value;
            maxSlots = [{ day, time }];
          } else if (value === maxCount) {
            maxSlots.push({ day, time });
          }
        });
      });

      // è¡¨ç¤ºä½œæˆ
      days.forEach(day => {
        const { æ˜¼, å¤œ } = counts[day];
        const row = document.createElement("div");
        row.className = "day-row";

        const label = document.createElement("div");
        label.className = "label";
        label.textContent = day;

        const countsDiv = document.createElement("div");
        countsDiv.className = "counts";

        const dayText = document.createElement("div");
        dayText.textContent = `æ˜¼ï¼š${æ˜¼}å`;
        if (maxSlots.find(s => s.day === day && s.time === "æ˜¼")) {
          const crown = document.createElement("span");
          crown.className = "crown";
          crown.textContent = "ğŸ‘‘";
          dayText.appendChild(crown);
        }

        const nightText = document.createElement("div");
        nightText.textContent = `å¤œï¼š${å¤œ}å`;
        if (maxSlots.find(s => s.day === day && s.time === "å¤œ")) {
          const crown = document.createElement("span");
          crown.className = "crown";
          crown.textContent = "ğŸ‘‘";
          nightText.appendChild(crown);
        }

        countsDiv.appendChild(dayText);
        countsDiv.appendChild(nightText);

        row.appendChild(label);
        row.appendChild(countsDiv);

        summary.appendChild(row);
      });
    }).catch(err => {
      console.error("å–å¾—ã‚¨ãƒ©ãƒ¼", err);
      summary.innerHTML = "<p>ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>";
    });

    // å…¨ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³
    document.getElementById("clear-button").addEventListener("click", async () => {
      const input = prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      if (input !== "tonegawasakurai") {
        alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ï¼");
        return;
      }

      if (!confirm("æœ¬å½“ã«å…¨ã¦ã®å›ç­”ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

      try {
        const snapshot = await db.collection("responses").get();
        const batch = db.batch();
        snapshot.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
        alert("å…¨ã¦ã®å›ç­”ã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼");
        location.reload();
      } catch (error) {
        console.error("å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", error);
        alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      }
    });
  </script>
</body>
</html>
