<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>飲み会回答集計</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Noto Sans JP', sans-serif;
      background-color: #fff;
      padding: 40px;
      text-align: center;
    }

    h1 {
      font-size: 26px;
      margin-bottom: 30px;
    }

    .day-block {
      margin-bottom: 40px;
    }

    .slot-row {
      margin: 10px 0;
    }

    .slot-label {
      font-weight: bold;
      display: inline-block;
      width: 100px;
      text-align: right;
    }

    .circle-names {
      font-weight: normal;
      color: #2e7d7c;
    }

    .small-count {
      margin-left: 10px;
      color: #444;
    }
  </style>
</head>
<body>
  <h1>🍻 回答集計ページ 🍻</h1>
  <div id="result">読み込み中...</div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyATmNqFm7juv8Vie3-62-L62BG8pCnCxWQ",
      authDomain: "github-nomikai-form.firebaseapp.com",
      projectId: "github-nomikai-form",
      storageBucket: "github-nomikai-form.firebasestorage.app",
      messagingSenderId: "1025705286107",
      appId: "1:1025705286107:web:8d915cd8273e5d58c96ffe",
      measurementId: "G-SKHX86H3E5"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const timeSlots = {
      "3月29日（土）": [
        { id: "3月29日（土）12:00～", label: "12:00～" },
        { id: "3月29日（土）17:00～", label: "17:00～" }
      ],
      "3月30日（日）": [
        { id: "3月30日（日）12:00～", label: "12:00～" },
        { id: "3月30日（日）17:00～", label: "17:00～" }
      ]
    };

    async function fetchData() {
      const snapshot = await db.collection("responses").get();
      const participants = snapshot.docs.map(doc => doc.data());

      const counts = {}; // 各スロットごとの○△✕カウントと○名前

      for (const day in timeSlots) {
        timeSlots[day].forEach(slot => {
          counts[slot.id] = {
            "○": [],
            "△": 0,
            "✕": 0
          };
        });
      }

      participants.forEach(p => {
        const res = p.responses || {};
        for (const slotId in res) {
          const mark = res[slotId];
          if (mark === "○") {
            counts[slotId]["○"].push(p.name);
          } else if (mark === "△" || mark === "✕") {
            counts[slotId][mark]++;
          }
        }
      });

      render(counts);
    }

    function render(counts) {
      const result = document.getElementById("result");
      result.innerHTML = "";

      for (const day in timeSlots) {
        const dayBlock = document.createElement("div");
        dayBlock.className = "day-block";

        const dayTitle = document.createElement("h3");
        dayTitle.textContent = `🗓 ${day}`;
        dayBlock.appendChild(dayTitle);

        timeSlots[day].forEach(slot => {
          const c = counts[slot.id];
          const row = document.createElement("div");
          row.className = "slot-row";

          const names = c["○"];
          const namesText = names.length > 0 ? names.join(" / ") : "なし";

          row.innerHTML = `
            <span class="slot-label">${slot.label}</span>
            〇 ${names.length}人：<span class="circle-names">${namesText}</span>
            <span class="small-count">△ ${c["△"]}人</span>
            <span class="small-count">✕ ${c["✕"]}人</span>
          `;

          dayBlock.appendChild(row);
        });

        result.appendChild(dayBlock);
      }
    }

    fetchData();
  </script>
</body>
</html>
